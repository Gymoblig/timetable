<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktívny rozvrh hodín</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .pdf-export {
            width: 100%;
            transform-origin: top left;
            margin-left: 170px;
            margin-top: 10px;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #0039A6;
        }

        .logo {
            width: 91px;
            height: 31px;
        }

        h1 {
            margin: 0;
            color: #0039A6;
            flex: 1;
        }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .controls button {
            padding: 8px 16px;
            margin-right: 10px;
            background: #0039A6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .controls button:hover {
            background: #002f85;
        }

        .controls button.clear {
            background: #f44336;
        }

        .controls button.clear:hover {
            background: #da190b;
        }

        .class-toggles {
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 4px;
            border: 2px solid #0039A6;
        }

        .class-toggles h3 {
            margin-bottom: 10px;
            color: #0039A6;
        }

        .toggle-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .toggle-item label {
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .available-classes {
            flex: 0 0 250px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            max-height: 800px;
            overflow-y: auto;
        }

        .available-classes h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .class-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: move;
            font-size: 12px;
            transition: all 0.2s;
        }

        .class-item:hover {
            border-color: #0039A6;
            transform: translateX(5px);
        }

        .class-item.dragging {
            opacity: 0.5;
        }

        .class-item.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .class-item.disabled {
            opacity: 0.2;
            cursor: not-allowed;
            background: #f0f0f0;
        }

        .timetable-wrapper {
            flex: 1;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 100px;
            
        }

        th {
            background: #0039A6;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;

        }

        td.day-label {
            background: #e3f2fd;
            font-weight: bold;
            color: #0039A6;
        }

        td.time-slot {
            font-size: 11px;
            background: #f1f1f1;
    
        }

        .cell-content {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 4px;
        }

        .placed-class {
            padding: 6px;
            border-radius: 4px;
            font-size: 11px;
            border: 2px solid #0039A6;
            background: white;
            position: relative;
            cursor: move;
            display: flex;
            flex-direction: column;
            
        }

        .placed-class.locked {
            background: #ffcdd2;
            border-color: #e91e63;
            cursor: not-allowed;
        }

        .placed-class .teacher {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            margin-top: 2px;
        }

        .placed-class .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            display: none;
        }

        .placed-class:hover .remove-btn {
            display: block;
        }

        .placed-class.locked .remove-btn {
            display: none !important;
        }
        
        .placed-class.span-start {
            position: absolute;
            left: 8px;
            right: calc(-100% - 1px);
            top: 8px;
            width: calc(200% + 1px);
            z-index: 10;
        }
        
        .placed-class.span-continue {
            visibility: hidden;
        }

        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 80px;
            position: relative;
        }

        .drop-zone {
            min-height: 60px;
            border: 2px dashed transparent;
        }

        .drop-zone.allowed {
            background: #e3f2fd;
        }

        .drop-zone.not-allowed {
            background: #ffebee;
            cursor: not-allowed;
        }

        .drop-zone.drag-over {
            border-color: #0039A6;
            background: #bbdefb;
        }

        .drop-zone.drag-over.not-allowed {
            border-color: #f44336;
            background: #ffcdd2;
        }

        .legend {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .legend-item {
            display: inline-block;
            margin-right: 20px;
            font-size: 14px;
        }

        .legend-box {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            margin-right: 5px;
            vertical-align: middle;
        }

        .legend-box.locked {
            background: #ffcdd2;
            border-color: #e91e63;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="logo" width="91" height="31" viewBox="0 0 91 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.3 17.8385C3.6 17.8385 4.6 16.8352 4.6 15.5309C4.6 14.2265 3.6 13.2231 2.3 13.2231C0.999999 13.2231 0 14.2265 0 15.5309C0 16.7349 0.999999 17.8385 2.3 17.8385Z" fill="#0039A6"/>
                <path d="M2.3 30.4807C3.6 30.4807 4.6 29.4774 4.6 28.173C4.6 26.8687 3.6 25.8654 2.3 25.8654C0.999999 25.8654 0 26.8687 0 28.173C0 29.4774 0.999999 30.4807 2.3 30.4807Z" fill="#0039A6"/>
                <path d="M14.9 17.8385C16.2 17.8385 17.2 16.8352 17.2 15.5309C17.2 14.2265 16.2 13.2231 14.9 13.2231C13.6 13.2231 12.6 14.2265 12.6 15.5309C12.6 16.7349 13.6 17.8385 14.9 17.8385Z" fill="#0039A6"/>
                <path d="M14.9 30.4807C16.2 30.4807 17.2 29.4774 17.2 28.173C17.2 26.8687 16.2 25.8654 14.9 25.8654C13.6 25.8654 12.6 26.8687 12.6 28.173C12.6 29.4774 13.6 30.4807 14.9 30.4807Z" fill="#0039A6"/>
                <path d="M27.5 17.8385C28.8 17.8385 29.8 16.8352 29.8 15.5309C29.8 14.2265 28.8 13.2231 27.5 13.2231C26.2 13.2231 25.2 14.2265 25.2 15.5309C25.2 16.7349 26.2 17.8385 27.5 17.8385Z" fill="#0039A6"/>
                <path d="M2.3 5.09607C3.6 5.09607 4.6 4.09274 4.6 2.78839C4.6 1.48405 3.6 0.480713 2.3 0.480713C0.999999 0.480713 0 1.48405 0 2.78839C0 4.09274 0.999999 5.09607 2.3 5.09607Z" fill="#0039A6"/>
                <path d="M14.9 5.09607C16.2 5.09607 17.2 4.09274 17.2 2.78839C17.2 1.48405 16.2 0.480713 14.9 0.480713C13.6 0.480713 12.6 1.48405 12.6 2.78839C12.6 4.09274 13.6 5.09607 14.9 5.09607Z" fill="#0039A6"/>
                <path d="M27.5 5.09607C28.8 5.09607 29.8 4.09274 29.8 2.78839C29.8 1.48405 28.8 0.480713 27.5 0.480713C26.2 0.480713 25.2 1.48405 25.2 2.78839C25.2 4.09274 26.2 5.09607 27.5 5.09607Z" fill="#0039A6"/>
                <path d="M27.5 30.4807C28.8 30.4807 29.8 29.4774 29.8 28.173C29.8 26.8687 28.8 25.8654 27.5 25.8654C26.2 25.8654 25.2 26.8687 25.2 28.173C25.2 29.4774 26.2 30.4807 27.5 30.4807Z" fill="#0039A6"/>
                <path d="M40.2 17.8385C41.5 17.8385 42.5 16.8352 42.5 15.5309C42.5 14.2265 41.5 13.2231 40.2 13.2231C38.9 13.2231 37.9 14.2265 37.9 15.5309C37.9 16.7349 38.9 17.8385 40.2 17.8385Z" fill="#0039A6"/>
                <path d="M40.2 30.4807C41.5 30.4807 42.5 29.4774 42.5 28.173C42.5 26.8687 41.5 25.8654 40.2 25.8654C38.9 25.8654 37.9 26.8687 37.9 28.173C37.9 29.4774 38.9 30.4807 40.2 30.4807Z" fill="#0039A6"/>
                <path d="M40.2 5.09607C41.5 5.09607 42.5 4.09274 42.5 2.78839C42.5 1.48405 41.5 0.480713 40.2 0.480713C38.9 0.480713 37.9 1.48405 37.9 2.78839C37.9 4.09274 38.9 5.09607 40.2 5.09607Z" fill="#0039A6"/>
                <path d="M79.3 18.0393C79.2 18.0393 79.1 18.1396 79.1 18.24V30.1798C79.1 30.2801 79.2 30.3804 79.3 30.3804H80.7C80.8 30.3804 80.9 30.2801 80.9 30.1798V18.24C80.9 18.1396 80.8 18.0393 80.7 18.0393H79.3ZM67.9 19.6446C67.9 19.5443 67.9 19.5443 68 19.5443H72.9C73 19.5443 73.1 19.444 73.1 19.3436V18.24C73.1 18.1396 73 18.0393 72.9 18.0393H66.3C66.2 18.0393 66.1 18.1396 66.1 18.24V30.1798C66.1 30.2801 66.2 30.3804 66.3 30.3804H72.9C73 30.3804 73.1 30.2801 73.1 30.1798V29.0761C73.1 28.9758 73 28.8754 72.9 28.8754H68C67.9 28.8754 67.9 28.7751 67.9 28.7751V24.862H71.9C72 24.862 72.1 24.7617 72.1 24.6614V23.5577C72.1 23.4574 72 23.357 71.9 23.357H67.9V19.6446ZM55.6 19.6446C55.6 19.5443 55.7 19.5443 55.7 19.5443H60.5C60.6 19.5443 60.7 19.444 60.7 19.3436V18.24C60.7 18.1396 60.6 18.0393 60.5 18.0393H54.1C54 18.0393 53.9 18.1396 53.9 18.24V30.1798C53.9 30.2801 54 30.3804 54.1 30.3804H55.5C55.6 30.3804 55.7 30.2801 55.7 30.1798V24.862H59.5C59.6 24.862 59.7 24.7617 59.7 24.6614V23.5577C59.7 23.4574 59.6 23.357 59.5 23.357H55.7V19.6446H55.6Z" fill="black"/>
                <path d="M90.8 0.882045C90.8 0.681376 90.7 0.681363 90.6 0.681363H88.3C88.2 0.681363 88.1 0.78171 88.1 0.882045V9.10945C88.1 10.3135 87.4 10.9155 86.1 10.9155C84.8 10.9155 84.1 10.3135 84.1 9.10945V0.882045C84.1 0.681376 84 0.681363 83.9 0.681363H81.6C81.4 0.681363 81.4 0.78171 81.4 0.882045V9.20979C81.4 11.6178 82.7 13.1228 86.1 13.1228C89.4 13.1228 90.8 11.6178 90.8 9.20979V0.882045ZM72.3 13.0225C72.5 13.0225 72.5 12.9222 72.5 12.8218V3.08938C72.5 2.98905 72.5 2.98907 72.6 2.98907H75.5C75.6 2.98907 75.7 2.88873 75.7 2.78839V1.0827C75.7 0.882026 75.6 0.882045 75.5 0.882045H66.8C66.6 0.882045 66.6 0.982361 66.6 1.0827V2.78839C66.6 2.98906 66.7 2.98907 66.8 2.98907H69.6C69.7 2.98907 69.7 3.08938 69.7 3.08938V12.8218C69.7 13.0225 69.8 13.0225 69.9 13.0225H72.3ZM53.5 12.4205C54.7 13.0225 55.8 13.1228 57.2 13.1228C59.8 13.1228 61.5 11.8185 61.5 9.41047C61.5 7.70479 60.7 6.6011 58.6 5.69809C56.8 4.99575 56.5 4.59443 56.5 3.99242C56.5 3.29008 57 2.78839 58.1 2.78839C58.9 2.78839 59.6 2.88872 60.2 3.18973C60.4 3.29006 60.5 3.18972 60.5 3.08938L61.3 1.48406C61.4 1.38372 61.4 1.28337 61.2 1.18304C60 0.681363 59.2 0.480713 57.6 0.480713C55.1 0.480713 53.6 1.98573 53.6 3.99242C53.6 5.79844 54.5 6.90211 56.6 7.80512C58.2 8.50746 58.6 8.90878 58.6 9.61112C58.6 10.3135 58 10.8152 57 10.8152C55.8 10.8152 55.2 10.6145 54.5 10.2131C54.4 10.1128 54.3 10.2131 54.2 10.3135L53.4 12.1195C53.4 12.3202 53.4 12.3202 53.5 12.4205Z" fill="black"/>
            </svg>
            <h1>Interaktívny rozvrh hodín</h1>
        </div>

        
        <div class="controls">
            <button onclick="clearMovableClasses()">Vymazať všetky presunuteľné hodiny</button>
            <button onclick="exportSchedule()">Exportovať rozvrh</button>
            <button class="clear" onclick="resetToDefault()">Resetovať na predvolené</button>
        </div>
        <div class="class-toggles">
            <h3>Voľba predmetov:</h3>
            <div class="toggle-group">
                <div class="toggle-item">
                    <input type="checkbox" id="toggleDV" onchange="toggleClass('DV')">
                    <label for="toggleDV">DV (Databázy a vizualizácia)</label>
                </div>
                <div class="toggle-item">
                    <input type="checkbox" id="togglePIOT" onchange="toggleClass('PIOT')">
                    <label for="togglePIOT">PIOT (Priemyselný IoT)</label>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="available-classes">
                <h3>Dostupné hodiny</h3>
                <div id="classList"></div>
            </div>

            <div class="timetable-wrapper">
                <table id="timetable">
                    <thead>
                        <tr>
                            <th>DEŇ</th>
                            <th>1<br><small>7:00-7:50</small></th>
                            <th>2<br><small>8:00-8:50</small></th>
                            <th>3<br><small>9:00-9:50</small></th>
                            <th>4<br><small>10:00-10:50</small></th>
                            <th>5<br><small>11:00-11:50</small></th>
                            <th>6<br><small>12:00-12:50</small></th>
                            <th>7<br><small>13:00-13:50</small></th>
                            <th>8<br><small>14:00-14:50</small></th>
                            <th>9<br><small>15:00-15:50</small></th>
                            <th>10<br><small>16:00-16:50</small></th>
                            <th>11<br><small>17:00-17:50</small></th>
                            <th>12<br><small>18:00-18:50</small></th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <span class="legend-box locked"></span>
                <span>Prednášky (Nemožno presunúť)</span>
            </div>
            <div class="legend-item">
                <span class="legend-box"></span>
                <span>Cvičenia (Presunuteľné)</span>
            </div>
        </div>
        

    </div>
    
    <script>
        const days = ['PONDELOK', 'UTOROK', 'STREDA', 'ŠTVRTOK', 'PIATOK'];
        const periods = 12;

        // Track which classes are enabled
        let enabledClasses = {
            'DV': false,
            'PIOT': false,
            'RRM': true,
            'SP': true,
            'UMINT': true
        };

        // Define all classes
        const availableClasses = [
            { id: 'RRM-1', name: 'RRM', teacher: 'BABINEC', code: '79/7 D619', locked: false, duration: 2, type: 'RRM' },
            { id: 'SP-1', name: 'SP', teacher: 'MIKLOVIČOVÁ', code: '75/8 D301', locked: false, duration: 2, type: 'SP' },
            { id: 'UMINT-1', name: 'UMINT', teacher: 'SEKAJ', code: '70/7(4) D712/D710', locked: false, duration: 2, type: 'UMINT' },
            { id: 'DV-1', name: 'DV', teacher: 'KÖRÖSI', code: '5/1 D301', locked: false, duration: 2, type: 'DV' },
            { id: 'PIOT-1', name: 'PIOT', teacher: 'MRAFKO', code: '60/6 D328', locked: false, duration: 2, type: 'PIOT' }
        ];

        // Function to get locked schedule based on enabled classes
        function getLockedSchedule() {
            const schedule = {
                'PONDELOK-4': [{ name: 'SP', teacher: 'Prednáška', code: '10:00-11:50', locked: true, duration: 2 }],
                'UTOROK-4': [{ name: 'UMINT', teacher: 'Prednáška', code: '10:00-11:50', locked: true, duration: 2 }],
                'ŠTVRTOK-4': [{ name: 'RRM', teacher: 'Prednáška', code: '10:00-11:50', locked: true, duration: 2 }]
            };

            // Add DV/PIOT lecture based on what's enabled
            if (enabledClasses['DV'] && enabledClasses['PIOT']) {
                schedule['PONDELOK-7'] = [{ name: 'DV/PIOT', teacher: 'Prednáška', code: '13:00-14:50', locked: true, duration: 2 }];
            } else if (enabledClasses['DV']) {
                schedule['PONDELOK-7'] = [{ name: 'DV', teacher: 'Prednáška', code: '13:00-14:50', locked: true, duration: 2 }];
            } else if (enabledClasses['PIOT']) {
                schedule['PONDELOK-7'] = [{ name: 'PIOT', teacher: 'Prednáška', code: '13:00-14:50', locked: true, duration: 2 }];
            }

            return schedule;
        }

        const allowedSlots = {
            'RRM-1': [
                ['UTOROK', 2, 3],
                ['UTOROK', 7, 8],
                ['UTOROK', 9, 10],
                ['STREDA', 2, 3],
                ['STREDA', 4, 5],
                ['STREDA', 7, 8],
                ['STREDA', 9, 10]
            ],
            'SP-1': [
                ['UTOROK', 7, 8],
                ['UTOROK', 9, 10],
                ['STREDA', 2, 3],
                ['STREDA', 4, 5],
                ['STREDA', 7, 8],
                ['STREDA', 9, 10],
                ['ŠTVRTOK', 7, 8],
                ['ŠTVRTOK', 9, 10]
            ],
            'UMINT-1': [
                ['UTOROK', 9, 10],
                ['STREDA', 7, 8],
                ['STREDA', 9, 10]
            ],
            'DV-1': [
                ['PONDELOK', 9, 10]
            ],
            'PIOT-1': [
                ['UTOROK', 7, 8],
                ['UTOROK', 9, 10],
                ['UTOROK', 11, 12],
                ['STREDA', 4, 5],
                ['STREDA', 7, 8]
            ]
        };

        let usedClasses = new Set();

        function toggleClass(className) {
            enabledClasses[className] = document.getElementById(`toggle${className}`).checked;
            
            // Remove the class from the timetable if it's disabled
            if (!enabledClasses[className]) {
                const classId = `${className}-1`;
                
                // Remove from timetable
                document.querySelectorAll(`.placed-class[data-class-id="${classId}"]`).forEach(el => {
                    const day = el.dataset.day;
                    const startPeriod = parseInt(el.dataset.startPeriod);
                    const duration = parseInt(el.dataset.duration);
                    
                    for (let i = 0; i < duration; i++) {
                        const period = startPeriod + i;
                        const cell = document.querySelector(`td[data-day="${day}"][data-period="${period}"]`);
                        if (cell) {
                            const element = cell.querySelector(`.placed-class[data-class-id="${classId}"]`);
                            if (element) element.remove();
                        }
                    }
                });
                
                usedClasses.delete(classId);
            }
            
            // Rebuild the timetable to update the locked lecture
            initializeTimetable();
        }

        function initializeTimetable() {
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            days.forEach(day => {
                const row = document.createElement('tr');
                const dayCell = document.createElement('td');
                dayCell.className = 'day-label';
                dayCell.textContent = day;
                row.appendChild(dayCell);

                for (let i = 1; i <= periods; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'drop-zone';
                    cell.dataset.day = day;
                    cell.dataset.period = i;
                    
                    const cellContent = document.createElement('div');
                    cellContent.className = 'cell-content';
                    cell.appendChild(cellContent);

                    setupDropZone(cell);
                    row.appendChild(cell);
                }

                tbody.appendChild(row);
            });

            // Add locked classes based on current settings
            const lockedSchedule = getLockedSchedule();
            Object.keys(lockedSchedule).forEach(key => {
                const [day, period] = key.split('-');
                lockedSchedule[key].forEach(cls => {
                    addClassToCell(day, parseInt(period), cls);
                });
            });

            updateAvailableClasses();
        }

        function updateAvailableClasses() {
            const classList = document.getElementById('classList');
            classList.innerHTML = '';

            availableClasses.forEach(cls => {
                const item = document.createElement('div');
                item.className = 'class-item';
                item.draggable = true;
                item.dataset.classId = cls.id;
                
                // Check if class is disabled due to toggle
                const isDisabled = !enabledClasses[cls.type];
                
                if (usedClasses.has(cls.id)) {
                    item.classList.add('used');
                    item.draggable = false;
                } else if (isDisabled) {
                    item.classList.add('disabled');
                    item.draggable = false;
                }

                item.innerHTML = `
                    <strong>${cls.name}</strong><br>
                    ${cls.teacher}<br>
                    <small>${cls.code}</small>
                `;

                if (!isDisabled) {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                }

                classList.appendChild(item);
            });
        }

        function addClassToCell(day, startPeriod, classData) {
            for (let i = 0; i < classData.duration; i++) {
                const period = startPeriod + i;
                const cell = document.querySelector(`td[data-day="${day}"][data-period="${period}"]`);
                if (!cell) {
                    console.error('Cell not found for:', day, period);
                    continue;
                }
                
                const cellContent = cell.querySelector('.cell-content');
                if (!cellContent) {
                    console.error('Cell content not found for:', day, period);
                    continue;
                }
                
                const placedClass = document.createElement('div');
                placedClass.className = 'placed-class';
                
                if (i === 0) {
                    placedClass.classList.add('span-start');
                } else {
                    placedClass.classList.add('span-continue');
                }
                
                if (classData.locked) {
                    placedClass.classList.add('locked');
                }
                placedClass.draggable = !classData.locked;
                placedClass.dataset.classId = classData.id || '';
                placedClass.dataset.day = day;
                placedClass.dataset.startPeriod = startPeriod;
                placedClass.dataset.duration = classData.duration;
                
                placedClass.innerHTML = `
                    <strong>${classData.name}</strong>
                    ${classData.teacher ? `<div class="teacher">${classData.teacher}</div>` : ''}
                    ${classData.code ? `<div class="teacher">${classData.code}</div>` : ''}
                    ${!classData.locked && i === 0 ? '<button class="remove-btn" onclick="removeClass(this)">×</button>' : ''}
                `;

                if (!classData.locked) {
                    placedClass.addEventListener('dragstart', handlePlacedClassDragStart);
                    placedClass.addEventListener('dragend', handleDragEnd);
                }

                cellContent.appendChild(placedClass);
            }
        }

        function handleDragStart(e) {
            if (e.target.classList.contains('used') || e.target.classList.contains('disabled')) {
                e.preventDefault();
                return;
            }
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.classId);
            e.dataTransfer.setData('source', 'list');
            
            const classId = e.target.dataset.classId;
            highlightAllowedSlots(classId);
        }

        function handlePlacedClassDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.classId);
            e.dataTransfer.setData('source', 'table');
            e.dataTransfer.setData('sourceCell', `${e.target.closest('td').dataset.day}-${e.target.closest('td').dataset.period}`);
            
            const classId = e.target.dataset.classId;
            highlightAllowedSlots(classId);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            clearHighlighting();
        }
        
        function highlightAllowedSlots(classId) {
            const allowed = allowedSlots[classId] || [];
            
            document.querySelectorAll('td[data-day]').forEach(cell => {
                const day = cell.dataset.day;
                const period = parseInt(cell.dataset.period);
                
                const isPartOfAllowed = allowed.some(slot => 
                    slot[0] === day && period >= slot[1] && period < slot[1] + 2
                );
                
                if (isPartOfAllowed) {
                    cell.classList.add('allowed');
                } else {
                    cell.classList.add('not-allowed');
                }
            });
        }
        
        function clearHighlighting() {
            document.querySelectorAll('td[data-day]').forEach(cell => {
                cell.classList.remove('allowed', 'not-allowed');
            });
        }

        function setupDropZone(cell) {
            cell.addEventListener('dragover', (e) => {
                e.preventDefault();
                cell.classList.add('drag-over');
            });

            cell.addEventListener('dragleave', () => {
                cell.classList.remove('drag-over');
            });

            cell.addEventListener('drop', (e) => {
                e.preventDefault();
                cell.classList.remove('drag-over');

                const classId = e.dataTransfer.getData('text/plain');
                const source = e.dataTransfer.getData('source');
                
                const targetDay = cell.dataset.day;
                const targetPeriod = parseInt(cell.dataset.period);

                if (source === 'list') {
                    const classData = availableClasses.find(c => c.id === classId);
                    
                    // Check if class is enabled
                    if (!enabledClasses[classData.type]) {
                        alert(`${classData.name} je momentálne vypnutý. Povoľte ho pomocou prepínača vyššie.`);
                        return;
                    }
                    
                    const allowed = allowedSlots[classId] || [];
                    const isAllowed = allowed.some(slot => 
                        slot[0] === targetDay && slot[1] === targetPeriod
                    );
                    
                    if (!isAllowed) {
                        alert(`${classData.name} nemôže byť umiestnený v tomto časovom slote!`);
                        return;
                    }
                    
                    for (let i = 0; i < classData.duration; i++) {
                        const checkPeriod = targetPeriod + i;
                        const checkCell = document.querySelector(`td[data-day="${targetDay}"][data-period="${checkPeriod}"]`);
                        if (!checkCell) {
                            alert('Nie je dostatok následných slotov!');
                            return;
                        }
                        const existingClasses = checkCell.querySelectorAll('.placed-class');
                        if (existingClasses.length > 0) {
                            alert('Jeden alebo viac požadovaných slotov je už obsadený!');
                            return;
                        }
                    }
                    
                    if (classData && !usedClasses.has(classId)) {
                        addClassToCell(targetDay, targetPeriod, classData);
                        usedClasses.add(classId);
                        updateAvailableClasses();
                    }
                } else if (source === 'table') {
                    const draggedElement = document.querySelector('.dragging');
                    
                    if (draggedElement && !draggedElement.classList.contains('locked')) {
                        const classId = draggedElement.dataset.classId;
                        const classData = availableClasses.find(c => c.id === classId);
                        const oldDay = draggedElement.dataset.day;
                        const oldStartPeriod = parseInt(draggedElement.dataset.startPeriod);
                        
                        const allowed = allowedSlots[classId] || [];
                        const isAllowed = allowed.some(slot => 
                            slot[0] === targetDay && slot[1] === targetPeriod
                        );
                        
                        if (!isAllowed) {
                            alert(`${classData.name} nemôže byť umiestnený v tomto časovom slote!`);
                            return;
                        }
                        
                        for (let i = 0; i < classData.duration; i++) {
                            const checkPeriod = targetPeriod + i;
                            const checkCell = document.querySelector(`td[data-day="${targetDay}"][data-period="${checkPeriod}"]`);
                            if (!checkCell) {
                                alert('Nie je dostatok následných slotov!');
                                return;
                            }
                            const existingClasses = Array.from(checkCell.querySelectorAll('.placed-class'));
                            const otherClasses = existingClasses.filter(el => 
                                el.dataset.classId !== classId
                            );
                            if (otherClasses.length > 0) {
                                alert('Jeden alebo viac požadovaných slotov je už obsadený!');
                                return;
                            }
                        }
                        
                        for (let i = 0; i < classData.duration; i++) {
                            const oldPeriod = oldStartPeriod + i;
                            const oldCell = document.querySelector(`td[data-day="${oldDay}"][data-period="${oldPeriod}"]`);
                            if (oldCell) {
                                const oldElement = oldCell.querySelector(`.placed-class[data-class-id="${classId}"]`);
                                if (oldElement) oldElement.remove();
                            }
                        }
                        
                        addClassToCell(targetDay, targetPeriod, classData);
                    }
                }
            });
        }

        function removeClass(btn) {
            const placedClass = btn.closest('.placed-class');
            const classId = placedClass.dataset.classId;
            const day = placedClass.dataset.day;
            const startPeriod = parseInt(placedClass.dataset.startPeriod);
            const duration = parseInt(placedClass.dataset.duration);
            
            for (let i = 0; i < duration; i++) {
                const period = startPeriod + i;
                const cell = document.querySelector(`td[data-day="${day}"][data-period="${period}"]`);
                if (cell) {
                    const element = cell.querySelector(`.placed-class[data-class-id="${classId}"]`);
                    if (element) element.remove();
                }
            }
            
            if (classId) {
                usedClasses.delete(classId);
                updateAvailableClasses();
            }
        }

        function clearMovableClasses() {
            if (!confirm('Ste si istí, že chcete vymazať všetky presunuteľné hodiny?')) return;

            document.querySelectorAll('.placed-class:not(.locked)').forEach(el => el.remove());
            usedClasses.clear();
            updateAvailableClasses();
        }

        function resetToDefault() {
            if (!confirm('Ste si istí, že chcete resetovať na predvolené nastavenia?')) return;
            usedClasses.clear();
            enabledClasses = { 'DV': true, 'PIOT': true };
            document.getElementById('toggleDV').checked = true;
            document.getElementById('togglePIOT').checked = true;
            initializeTimetable();
        }

        function exportSchedule() {
            const timetable = document.getElementById('timetable');
            timetable.classList.add('pdf-export');

            const opt = {

            filename: 'rozvrh.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: {
                scale: 4,
                scrollX: 0,
                scrollY: 0,
                windowWidth: timetable.scrollWidth 
            },
            jsPDF: {
                unit: 'mm',
                format: 'a3', 
                orientation: 'landscape'
            }
        };

        html2pdf()
            .set(opt)
            .from(timetable)
            .save()
            .then(() => {
                timetable.classList.remove('pdf-export');
            });
        }

        // Initialize on load
        initializeTimetable();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</body>
</html>
